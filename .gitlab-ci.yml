image: "redoxos/redoxer:latest"

stages:
  - build
  - test

before_script:
  - apt-get update -qq
  - apt-get install -qq git

cache:
  paths:
      - target/

build:linux:
  stage: build
  script:
      - rustup toolchain add "$(cat rust-toolchain)"
      - rustup show      # Print version info for debugging
      - cargo build

build:redox:
  stage: build
  variables:
      TARGET: x86_64-unknown-redox
  script:
      - export RUSTUP_TOOLCHAIN="$HOME/.redoxer/toolchain"
      - export PATH="$RUSTUP_TOOLCHAIN/bin:$PATH"
      - rustup show      # Print version info for debugging
      - cargo install redoxer
      - redoxer toolchain
      - redoxer build --verbose

test:linux:
    stage: test
    dependencies:
        - build:linux
    script:
        - cargo test --verbose

fmt:
    stage: test
    script:
        - rustup component add rustfmt-preview
        - ./fmt.sh -- --check
    allow_failure: true